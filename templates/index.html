<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Multijoueurs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: white;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #game-section {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .table {
            background-color: #2d572c;
            background-image: radial-gradient(circle at center, #3a6b39 0%, #2d572c 70%);
            border-radius: 200px;
            padding: 30px;
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 500px;
            width: 80%;
            max-width: 1000px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            border: 12px solid #4a3527;
            margin-top: 40px;
        }

        .board {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 15px;
            min-width: 300px;
        }

        .card {
            display: inline-block;
            width: 60px;
            height: 85px;
            background-color: white;
            border-radius: 8px;
            margin: 0 5px;
            color: black;
            line-height: 85px;
            font-size: 24px;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .card.red {
            color: #d40000;
        }

        .card.winning {
            box-shadow: 0 0 20px #ffd700;
            transform: scale(1.15);
            background-color: #fffacd;
            z-index: 10;
        }

        .player-spot {
            position: absolute;
            width: 130px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .player-spot.active {
            box-shadow: 0 0 25px #ffd700;
            transform: scale(1.05);
            z-index: 100;
        }

        .player-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            top: -15px;
            right: -15px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 101;
        }

        .dealer-button {
            background-color: #ffffff;
            border: 2px solid #4CAF50;
            color: #000;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .big-blind-button {
            background-color: #ff9800;
            border: 2px solid #f57c00;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mise {
            position: absolute;
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .pot {
            font-size: 28px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            background-color: rgba(0, 0, 0, 0.6);
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
        }

        /* Positions des joueurs réorganisées pour 7 joueurs */
        .player-spot:nth-child(1) { bottom: 2%; left: 50%; transform: translateX(-50%); }     /* Bas centre */
        .player-spot:nth-child(2) { bottom: 10%; right: 10%; }                                /* Coin bas droite */
        .player-spot:nth-child(3) { top: 45%; right: 2%; }                                    /* Milieu droite */
        .player-spot:nth-child(4) { top: 15%; right: 15%; }                                   /* Haut droite */
        .player-spot:nth-child(5) { top: 15%; left: 15%; }                                    /* Haut gauche */
        .player-spot:nth-child(6) { top: 45%; left: 2%; }                                     /* Milieu gauche */
        .player-spot:nth-child(7) { bottom: 10%; left: 10%; }                                 /* Coin bas gauche */

        .mes-cartes-container {
            position: fixed;
            bottom: 20px;
            left: 78%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .tour-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 18px;
            z-index: 100;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 12px;
            z-index: 900;
            width: auto;
            max-width: 90%;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .login-section {
            text-align: center;
            margin-top: 100px;
        }

        .phase-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 18px;
        }

        .notifications-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            pointer-events: none;
        }

        .notification {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            margin-top: 10px;
            animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-out 4.5s forwards;
            max-width: 300px;
            pointer-events: auto;
        }

        .notification.success {
            border-left: 4px solid #4CAF50;
        }

        .notification.error {
            border-left: 4px solid #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .notification.action {
            background-color: rgba(33, 150, 243, 0.1);
        }
        
        .notification.phase {
            background-color: rgba(255, 152, 0, 0.1);
        }

        .historique-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
        }

        .modal-content {
            position: relative;
            background-color: #2d2d2d;
            margin: 10% auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            color: white;
            max-height: 80vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 rgba(0, 0, 0, 0.2);
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background-color: #4CAF50;
            border-radius: 4px;
        }

        .close-modal {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .close-modal:hover {
            color: white;
        }

        .main-info {
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            background-color: rgba(74, 175, 80, 0.1);
        }

        .lobby-section {
            text-align: center;
            margin: 20px auto;
            max-width: 800px;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .lobby-section h1 {
            font-size: 3em;
            margin-bottom: 40px;
            color: #4CAF50;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .create-table-section {
            margin-bottom: 40px;
            padding: 30px;
            background-color: rgba(45, 87, 44, 0.4);
            border-radius: 15px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .create-table-section h2 {
            color: #fff;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .create-table-section input {
            padding: 12px 20px;
            margin: 0 10px;
            border-radius: 8px;
            border: 2px solid rgba(76, 175, 80, 0.5);
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
            width: 200px;
            transition: all 0.3s ease;
        }

        .create-table-section input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .create-table-section button {
            margin-left: 10px;
            background-color: #4CAF50;
            padding: 12px 25px;
            font-size: 16px;
        }

        .tables-list {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: calc(100vh - 350px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 rgba(0, 0, 0, 0.2);
        }

        .tables-list::-webkit-scrollbar {
            width: 8px;
        }

        .tables-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .tables-list::-webkit-scrollbar-thumb {
            background-color: #4CAF50;
            border-radius: 4px;
        }

        .tables-list h2 {
            color: #fff;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .table-item {
            background-color: rgba(45, 87, 44, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(76, 175, 80, 0.2);
            transition: all 0.3s ease;
        }

        .table-item:hover {
            background-color: rgba(45, 87, 44, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .table-info {
            text-align: left;
            flex-grow: 1;
        }

        .table-info > div:first-child {
            font-size: 1.2em;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .table-players {
            font-size: 0.9em;
            color: #bbb;
        }

        .join-button {
            background-color: #2196F3;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .join-button:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .notification.warning {
            border-left: 4px solid #ff9800;
            background-color: rgba(255, 152, 0, 0.1);
        }

        /* Style pour le croupier */
        .croupier {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background-color: #1a1a1a;
            border-radius: 50%;
            border: 3px solid #4a3527;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .croupier::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 50%;
            bottom: 0;
            background-color: #4CAF50;
            border-top: 2px solid #45a049;
        }

        .croupier::before {
            content: '👔';
            font-size: 40px;
            position: relative;
            top: 5px;
            z-index: 1;
        }

        /* Style pour le bouton quitter */
        .quit-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f44336;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            z-index: 1000;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .quit-button:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-section" class="lobby-section">
            <h1>Poker Multijoueurs</h1>
            <div class="create-table-section">
                <h2>Créer une nouvelle table</h2>
                <div class="input-group">
                    <input type="text" id="username" placeholder="Votre nom" maxlength="20">
                    <button onclick="creerTable()">Créer une table</button>
                </div>
            </div>
            
            <div class="tables-list" id="tables-list">
                <h2>Tables disponibles</h2>
                <!-- Les tables seront ajoutées ici dynamiquement -->
            </div>
        </div>

        <div id="game-section" style="display: none;">
            <button class="quit-button" onclick="quitterTable()">Quitter la table</button>
            <div id="tour-indicator" class="tour-indicator" style="display: none;">
                En attente des joueurs...
            </div>
            <div class="table">
                <div class="croupier"></div>
                <div class="phase-indicator" id="phase">En attente</div>
                <div class="board">
                    <div class="pot" id="pot">Pot: 0€</div>
                    <div id="cartes-communes"></div>
                </div>
                <div id="joueurs"></div>
            </div>

            <div class="mes-cartes-container">
                <h3>Vos cartes</h3>
                <div id="mes-cartes"></div>
                <div id="ma-combinaison" style="margin-top: 10px; font-size: 18px; color: #4CAF50; font-weight: bold;"></div>
            </div>

            <div class="controls">
                <button onclick="demarrerPartie()" id="btn-demarrer">Démarrer la partie</button>
                <button onclick="suivre()" id="btn-suivre" disabled>Suivre</button>
                <button onclick="miser()" id="btn-miser" disabled>Miser</button>
                <input type="number" id="mise-montant" placeholder="Montant" min="0" step="10">
                <button onclick="seCoucher()" id="btn-coucher" disabled>Se coucher</button>
            </div>
        </div>

        <div id="historique-button" class="historique-button" style="display: none;">
            Dernière main
        </div>
        
        <div id="historique-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="fermerModal()">&times;</span>
                <h2>Dernière main jouée</h2>
                <div id="historique-content"></div>
            </div>
        </div>
    </div>

    <div class="notifications-container" id="notifications"></div>

    <script>
        const socket = io({
            pingInterval: 5000,  // 5 secondes au lieu de 2
            pingTimeout: 10000,   // 10 secondes au lieu de 5
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 5
        });
        let currentUser = '';
        let currentRoom = '';
        let monTour = false;
        let lastPong = Date.now();
        let connectionCheckInterval;
        let isConnected = true;  // Nouvel état pour suivre la connexion
        let derniereMain = null;  // Pour stocker la dernière main
        let tables = {};  // Pour stocker les informations des tables

        // Gestion de la connexion/déconnexion
        socket.on('connect', () => {
            isConnected = true;
            if (!isConnected) {  // Afficher la notification seulement si on était déconnecté
                showNotification('Connecté au serveur', 'success');
            }
            startConnectionCheck();
            // Si on était déjà dans une partie, tenter de la rejoindre
            if (currentUser && currentRoom) {
                socket.emit('rejoindre_partie', {
                    username: currentUser,
                    room: currentRoom
                });
            }
        });

        socket.on('disconnect', (reason) => {
            isConnected = false;
            showNotification('Déconnecté du serveur: ' + reason, 'error');
            stopConnectionCheck();
        });

        socket.on('connect_error', (error) => {
            showNotification('Erreur de connexion: ' + error.message, 'error');
        });

        // Fonction pour vérifier la connexion
        function startConnectionCheck() {
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
            }
            connectionCheckInterval = setInterval(() => {
                if (Date.now() - lastPong > 15000) {  // 15 secondes au lieu de 10
                    if (isConnected) {  // Afficher la notification seulement si on était connecté
                        isConnected = false;
                        showNotification('Connexion perdue, tentative de reconnexion...', 'error');
                    }
                    socket.connect();
                } else {
                    socket.emit('ping_client');
                }
            }, 10000);  // 10 secondes au lieu de 5
        }

        function stopConnectionCheck() {
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
                connectionCheckInterval = null;
            }
        }

        socket.on('pong_server', () => {
            lastPong = Date.now();
        });

        // Gestion de la reconnexion
        socket.on('reconnect', () => {
            if (currentUser && currentRoom) {
                // Tenter de rejoindre à nouveau la partie
                socket.emit('rejoindre_partie', {
                    username: currentUser,
                    room: currentRoom
                });
                showNotification('Reconnecté à la partie', 'success');
            }
        });

        function creerTable() {
            const username = document.getElementById('username').value;
            if (!username) {
                showNotification('Veuillez entrer votre nom', 'error');
                return;
            }
            
            const tableId = 'table_' + Date.now();  // Création d'un ID unique
            currentUser = username;
            currentRoom = tableId;
            
            socket.emit('creer_table', {
                username: username,
                room: tableId
            });
        }

        function rejoindreTable(tableId) {
            const username = document.getElementById('username').value;
            if (!username) {
                showNotification('Veuillez entrer votre nom', 'error');
                return;
            }
            
            if (tables[tableId] && Object.keys(tables[tableId].joueurs).length >= 7) {
                showNotification('La table est pleine (7 joueurs maximum)', 'error');
                return;
            }
            
            currentUser = username;
            currentRoom = tableId;
            
            socket.emit('rejoindre_partie', {
                username: username,
                room: tableId
            });
        }

        function updateTablesList(tables) {
            const tablesList = document.getElementById('tables-list');
            let html = '<h2>Tables disponibles</h2>';
            
            if (Object.keys(tables).length === 0) {
                html += '<div style="text-align: center; margin-top: 20px; color: #666;">Aucune table disponible</div>';
            } else {
                Object.entries(tables).forEach(([tableId, tableInfo]) => {
                    if (tableInfo.joueurs && Object.keys(tableInfo.joueurs).length > 0) {
                        const joueurs = Object.keys(tableInfo.joueurs).join(', ');
                        const nbJoueurs = Object.keys(tableInfo.joueurs).length;
                        html += `
                            <div class="table-item">
                                <div class="table-info">
                                    <div>Table #${tableId.slice(-4)}</div>
                                    <div class="table-players">Joueurs (${nbJoueurs}/7): ${joueurs}</div>
                                </div>
                                <button class="join-button" onclick="rejoindreTable('${tableId}')">
                                    Rejoindre
                                </button>
                            </div>
                        `;
                    }
                });
            }
            
            tablesList.innerHTML = html;
        }

        // Nouveaux événements socket
        socket.on('update_tables', (data) => {
            tables = data.tables;
            updateTablesList(tables);
            
            // Si notre table n'existe plus, retourner au lobby
            if (currentRoom && !tables[currentRoom]) {
                document.getElementById('game-section').style.display = 'none';
                document.getElementById('login-section').style.display = 'block';
                currentRoom = '';
                currentUser = '';
                showNotification('La table a été fermée', 'warning');
            }
        });

        socket.on('table_creee', (data) => {
            showNotification('Table créée avec succès', 'success');
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';
        });

        function demarrerPartie() {
            socket.emit('demarrer_partie', {
                room: currentRoom
            });
        }

        function updateControls() {
            const buttons = document.querySelectorAll('.controls button');
            const miseInput = document.getElementById('mise-montant');
            
            buttons.forEach(btn => {
                if (btn.id !== 'btn-demarrer') {
                    btn.disabled = !monTour;
                }
            });
            
            if (monTour) {
                miseInput.disabled = false;
                miseInput.value = ''; // Réinitialiser la valeur
            } else {
                miseInput.disabled = true;
            }
        }

        function miser() {
            const montant = parseInt(document.getElementById('mise-montant').value);
            if (montant > 0) {
                socket.emit('action_joueur', {
                    action: 'mise',
                    montant: montant,
                    username: currentUser,
                    room: currentRoom
                });
            }
        }

        function suivre() {
            socket.emit('action_joueur', {
                action: 'suivre',
                username: currentUser,
                room: currentRoom
            });
        }

        function seCoucher() {
            socket.emit('action_joueur', {
                action: 'coucher',
                username: currentUser,
                room: currentRoom
            });
        }

        socket.on('joueur_rejoint', (data) => {
            showNotification(`${data.username} a rejoint la partie`, 'success');
            updateJoueurs(data.joueurs);
        });

        socket.on('activer_demarrage', () => {
            const btnDemarrer = document.getElementById('btn-demarrer');
            btnDemarrer.disabled = false;
            btnDemarrer.style.display = 'block';
            showNotification('La partie peut démarrer !', 'success');
        });

        socket.on('partie_demarree', () => {
            document.getElementById('btn-demarrer').style.display = 'none';
            showNotification('La partie commence !', 'success');
        });

        function afficherCarte(carte) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            if (carte.couleur === '♥' || carte.couleur === '♦') {
                cardDiv.className += ' red';
            }
            cardDiv.textContent = `${carte.valeur}${carte.couleur}`;
            return cardDiv;
        }

        socket.on('recevoir_cartes', (data) => {
            const mesCartes = document.getElementById('mes-cartes');
            mesCartes.innerHTML = '';
            data.cartes.forEach(carte => {
                mesCartes.appendChild(afficherCarte(carte));
            });
        });

        socket.on('update_game_state', (data) => {
            document.getElementById('pot').textContent = `Pot: ${data.pot}€`;
            document.getElementById('phase').textContent = traduirePhase(data.phase);
            
            // Mise à jour de l'indicateur de tour
            const tourIndicator = document.getElementById('tour-indicator');
            tourIndicator.style.display = 'block';
            if (data.tour_actuel === currentUser) {
                tourIndicator.textContent = "C'est à votre tour de jouer!";
                tourIndicator.style.backgroundColor = '#4CAF50';
            } else if (data.tour_actuel) {
                tourIndicator.textContent = `C'est au tour de ${data.tour_actuel}`;
                tourIndicator.style.backgroundColor = '#666';
            } else {
                tourIndicator.textContent = 'En attente des joueurs...';
            }
            
            monTour = data.tour_actuel === currentUser;
            updateControls();
            updateJoueurs(data.joueurs);
            
            // Mise à jour des cartes communes
            if (data.cartes_communes) {
                const cartesCommunes = document.getElementById('cartes-communes');
                cartesCommunes.innerHTML = '';
                data.cartes_communes.forEach(carte => {
                    cartesCommunes.appendChild(afficherCarte(carte));
                });
                
                // Réappliquer la surbrillance après la mise à jour des cartes
                socket.emit('demander_combinaison', {
                    username: currentUser,
                    room: currentRoom
                });
            }
        });

        function traduirePhase(phase) {
            const traductions = {
                'attente': 'En attente',
                'preflop': 'Pre-flop',
                'flop': 'Flop',
                'turn': 'Turn',
                'river': 'River'
            };
            return traductions[phase] || phase;
        }

        function updateJoueurs(joueurs) {
            const joueursDiv = document.getElementById('joueurs');
            joueursDiv.innerHTML = '';
            
            let joueursArray = Object.entries(joueurs);
            const currentPlayerIndex = joueursArray.findIndex(([username]) => username === currentUser);
            
            if (currentPlayerIndex !== -1) {
                joueursArray = [
                    ...joueursArray.slice(currentPlayerIndex),
                    ...joueursArray.slice(0, currentPlayerIndex)
                ];
            }
            
            const positions = [
                { bottom: '2%', left: '50%', transform: 'translateX(-50%)' },    /* Bas centre */
                { bottom: '10%', right: '10%' },                                 /* Coin bas droite */
                { top: '45%', right: '2%' },                                     /* Milieu droite */
                { top: '15%', right: '15%' },                                    /* Haut droite */
                { top: '15%', left: '15%' },                                     /* Haut gauche */
                { top: '45%', left: '2%' },                                      /* Milieu gauche */
                { bottom: '10%', left: '10%' }                                   /* Coin bas gauche */
            ];
            
            joueursArray.forEach(([username, data], index) => {
                if (index >= positions.length) return;
                
                const spot = document.createElement('div');
                spot.className = `player-spot${username === currentUser ? ' active' : ''}`;
                spot.setAttribute('data-username', username);
                
                Object.assign(spot.style, positions[index]);
                
                let miseHtml = '';
                if (data.mise_tour > 0) {
                    miseHtml = `<div class="mise">${data.mise_tour}€</div>`;
                }
                
                let statusHtml = '';
                if (!data.en_jeu) {
                    statusHtml = '<div>(Couché)</div>';
                }

                // Ajouter les indicateurs de dealer et big blind
                let indicatorsHtml = '';
                if (data.is_dealer) {
                    indicatorsHtml += '<div class="player-indicator dealer-button">D</div>';
                }
                if (data.is_big_blind) {
                    indicatorsHtml += '<div class="player-indicator big-blind-button">BB</div>';
                }
                
                spot.innerHTML = `
                    ${miseHtml}
                    ${indicatorsHtml}
                    <div>${username}</div>
                    <div>${data.jetons}€</div>
                    ${statusHtml}
                `;
                joueursDiv.appendChild(spot);
            });
        }

        // Au chargement initial, désactiver le bouton démarrer
        document.addEventListener('DOMContentLoaded', () => {
            const btnDemarrer = document.getElementById('btn-demarrer');
            btnDemarrer.disabled = true;
        });

        socket.on('fin_manche', (data) => {
            derniereMain = data;  // Sauvegarder la dernière main
            document.getElementById('historique-button').style.display = 'block';
            
            let message = `${data.gagnant} gagne le pot de ${data.gain}€`;
            showNotification(message, 'success');
            
            // Réinitialiser l'affichage des cartes gagnantes
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('winning');
            });
            
            // Afficher les cartes gagnantes du gagnant
            if (data.mains && data.mains[data.gagnant]) {
                const cartesGagnantes = data.mains[data.gagnant].cartes_gagnantes.map(c => `${c.valeur}${c.couleur}`);
                document.querySelectorAll('.card').forEach(card => {
                    const cardText = card.textContent.trim();
                    if (cartesGagnantes.includes(cardText)) {
                        card.classList.add('winning');
                    }
                });
            }
        });

        socket.on('nouvelle_manche', (data) => {
            showNotification('Nouvelle manche dans ' + data.delai + ' secondes...', 'success');
            setTimeout(() => {
                socket.emit('demarrer_partie', {
                    room: currentRoom
                });
            }, data.delai * 1000);
        });

        socket.on('erreur', (data) => {
            showNotification(data.message, 'error');
        });

        socket.on('combinaison_actuelle', (data) => {
            document.getElementById('ma-combinaison').textContent = data.combinaison;
            
            // Réinitialiser toutes les cartes
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('winning');
            });
            
            // Mettre en surbrillance les cartes gagnantes
            if (data.cartes_gagnantes) {
                const cartesGagnantes = data.cartes_gagnantes.map(c => `${c.valeur}${c.couleur}`);
                
                // Vérifier toutes les cartes (communes et personnelles)
                document.querySelectorAll('.card').forEach(card => {
                    const cardText = card.textContent.trim();
                    if (cartesGagnantes.includes(cardText)) {
                        card.classList.add('winning');
                    }
                });
            }
        });

        // Gestion des notifications
        socket.on('notification', (data) => {
            const type = data.type || 'success';  // 'action' ou 'phase' ou par défaut 'success'
            showNotification(data.message, type);
        });

        // Fonction de notification améliorée
        function showNotification(message, type = 'success') {
            const notifContainer = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Ajouter des styles spécifiques selon le type
            if (type === 'action') {
                notification.style.borderLeft = '4px solid #2196F3';  // Bleu pour les actions
            } else if (type === 'phase') {
                notification.style.borderLeft = '4px solid #FF9800';  // Orange pour les phases
            }
            
            notifContainer.appendChild(notification);
            
            // Supprimer la notification après 5 secondes
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Ajouter un gestionnaire pour la fermeture de la fenêtre
        window.addEventListener('beforeunload', (event) => {
            if (currentUser && currentRoom) {
                // Forcer l'envoi synchrone avant la fermeture
                socket.emit('quitter_partie', {
                    username: currentUser,
                    room: currentRoom
                });
                socket.disconnect();
            }
        });

        // Mise à jour de la gestion des déconnexions
        socket.on('joueur_parti', (data) => {
            showNotification(`${data.username} a quitté la partie`, 'warning');
            
            // Retirer visuellement le joueur de la table
            const playerSpot = document.querySelector(`.player-spot[data-username="${data.username}"]`);
            if (playerSpot) {
                playerSpot.remove();
            }
            
            // Si c'était le dernier joueur, retourner au lobby
            if (currentRoom && (!tables[currentRoom] || !tables[currentRoom].joueurs || Object.keys(tables[currentRoom].joueurs).length === 0)) {
                document.getElementById('game-section').style.display = 'none';
                document.getElementById('login-section').style.display = 'block';
                currentRoom = '';
                currentUser = '';
            }
        });

        function quitterTable() {
            if (confirm('Êtes-vous sûr de vouloir quitter la table ?')) {
                socket.emit('quitter_partie', {
                    username: currentUser,
                    room: currentRoom
                });
                
                // Retour au lobby
                document.getElementById('game-section').style.display = 'none';
                document.getElementById('login-section').style.display = 'block';
                
                // Réinitialisation des variables
                currentRoom = '';
                currentUser = '';
                
                showNotification('Vous avez quitté la table', 'warning');
            }
        }

        // Fonctions pour le modal
        function ouvrirModal() {
            document.getElementById('historique-modal').style.display = 'block';
            if (derniereMain) {
                afficherDerniereMain(derniereMain);
            }
        }

        function fermerModal() {
            document.getElementById('historique-modal').style.display = 'none';
        }

        function afficherDerniereMain(data) {
            const content = document.getElementById('historique-content');
            const gain = data.gain || data.pot || 0;  // Utiliser gain ou pot ou 0 par défaut
            let html = `<div class="main-info">
                <h3>${data.gagnant} a gagné ${gain}€</h3>
            </div>`;

            if (data.mains) {
                html += '<h4>Mains des joueurs:</h4>';
                for (const [joueur, info] of Object.entries(data.mains)) {
                    const style = joueur === data.gagnant ? 'border-left: 4px solid #ffd700; padding-left: 10px;' : '';
                    let cartesText = '';
                    
                    // Vérifier si nous avons les cartes dans le bon format
                    if (Array.isArray(info.cartes)) {
                        cartesText = info.cartes.map(c => `${c.valeur}${c.couleur}`).join(', ');
                    } else if (info.main_complete) {
                        cartesText = info.main_complete.map(c => `${c.valeur}${c.couleur}`).join(', ');
                    }
                    
                    html += `<div style="${style}">
                        <strong>${joueur}</strong>: ${cartesText}<br>
                        <em>${info.combinaison || ''}</em>
                    </div><br>`;
                }
            }
            content.innerHTML = html;
        }

        // Ajouter le gestionnaire de clic pour le bouton d'historique
        document.getElementById('historique-button').onclick = ouvrirModal;

        // Fermer le modal si on clique en dehors
        window.onclick = function(event) {
            const modal = document.getElementById('historique-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Gestion de la déconnexion des joueurs
        socket.on('joueur_deconnecte', (data) => {
            showNotification(data.message, 'warning');
            // Mettre à jour visuellement le joueur déconnecté
            const playerSpot = document.querySelector(`.player-spot[data-username="${data.username}"]`);
            if (playerSpot) {
                playerSpot.style.opacity = '0.5';
                playerSpot.innerHTML += '<div>(Déconnecté)</div>';
            }
        });
    </script>
</body>
</html> 